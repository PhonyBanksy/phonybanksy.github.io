rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ────────────────────────────────────────────────────

    // Is the caller signed in?
    function isAuth() {
      return request.auth != null;
    }

    // Is the caller the document owner?
    function isOwner(uid) {
      return isAuth() && request.auth.uid == uid;
    }

    // Is the caller an admin?
    // We check the users collection rather than custom claims for simplicity.
    function isAdmin() {
      return isAuth() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Enforce a maximum string field length
    function maxLen(field, n) {
      return field is string && field.size() <= n;
    }

    // Validate a waypoint map has required numeric fields
    function validWaypoint(wp) {
      return wp is map
        && wp.keys().hasAll(['rotation', 'translation', 'scale3D'])
        && wp.rotation  is map
        && wp.translation is map
        && wp.scale3D   is map;
    }

    // ── /users/{uid} ────────────────────────────────────────────────────────
    match /users/{uid} {

      // Anyone signed in can read their own document.
      // Admins can read any user document.
      allow read: if isOwner(uid) || isAdmin();

      // Only the owner can create their own document.
      allow create: if isOwner(uid)
        && request.resource.data.keys().hasAll(['googleDisplayName','email','inGameName','discordName','role','createdAt'])
        // Enforce role is always 'user' on creation (admins must be set via console)
        && request.resource.data.role == 'user'
        && maxLen(request.resource.data.inGameName,  64)
        && maxLen(request.resource.data.discordName, 64)
        && maxLen(request.resource.data.googleDisplayName, 128)
        && maxLen(request.resource.data.email, 256);

      // Owner can update their profile fields, but NOT role or email.
      allow update: if isOwner(uid)
        && !('role'  in request.resource.data.diff(resource.data).affectedKeys())
        && !('email' in request.resource.data.diff(resource.data).affectedKeys())
        && maxLen(request.resource.data.inGameName,  64)
        && maxLen(request.resource.data.discordName, 64);

      // No user deletions allowed (admin must use console)
      allow delete: if false;
    }

    // ── /routes/{routeId} ───────────────────────────────────────────────────
    match /routes/{routeId} {

      // Public routes can be read by anyone.
      // Hidden routes can only be read by their owner or an admin.
      allow read: if resource.data.isPublic == true
                  || isOwner(resource.data.ownerUid)
                  || isAdmin();

      // Authenticated users can create routes.
      allow create: if isAuth()
        // Must claim their own UID
        && request.resource.data.ownerUid    == request.auth.uid
        && request.resource.data.characterId == request.auth.uid
        // Required fields
        && request.resource.data.keys().hasAll([
             'ownerUid','characterId','inGameName','routeName',
             'routeData','isPublic','waypointCount','createdAt','updatedAt'
           ])
        // Field size limits
        && maxLen(request.resource.data.routeName,  128)
        && maxLen(request.resource.data.inGameName,  64)
        // waypointCount must be a positive integer ≤ 500
        && request.resource.data.waypointCount is int
        && request.resource.data.waypointCount >= 1
        && request.resource.data.waypointCount <= 500
        // isPublic must be a bool
        && request.resource.data.isPublic is bool
        // routeData must be a map with a waypoints list
        && request.resource.data.routeData is map
        && request.resource.data.routeData.keys().hasAll(['routeName','waypoints'])
        && request.resource.data.routeData.waypoints is list
        && request.resource.data.routeData.waypoints.size() >= 1
        && request.resource.data.routeData.waypoints.size() <= 500;

      // Owner or admin can update.
      allow update: if (isOwner(resource.data.ownerUid) || isAdmin())
        // Cannot reassign ownership
        && request.resource.data.ownerUid    == resource.data.ownerUid
        && request.resource.data.characterId == resource.data.characterId
        // Same field constraints as create
        && maxLen(request.resource.data.routeName,  128)
        && maxLen(request.resource.data.inGameName,  64)
        && request.resource.data.waypointCount is int
        && request.resource.data.waypointCount >= 1
        && request.resource.data.waypointCount <= 500
        && request.resource.data.isPublic is bool
        && request.resource.data.routeData is map
        && request.resource.data.routeData.keys().hasAll(['routeName','waypoints'])
        && request.resource.data.routeData.waypoints is list
        && request.resource.data.routeData.waypoints.size() >= 1
        && request.resource.data.routeData.waypoints.size() <= 500;

      // Owner or admin can delete.
      allow delete: if isOwner(resource.data.ownerUid) || isAdmin();
    }

  }
}
