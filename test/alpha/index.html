<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MotorTown Route Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800&family=Barlow:wght@300;400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
</head>
<body>
<div id="app">

  <header id="topbar" style="grid-column: 1 / -1;">
    <div class="logo">
      <div class="logo-mark"></div>
      <span class="logo-text">Motor<em>Town</em> Route Editor</span>
    </div>
    <div class="vsep"></div>
    <div class="status-pill">
      <div class="dot"></div>
      <span id="mapStatus">Trying auto-load‚Ä¶</span>
    </div>

    <div class="topbar-end">
      <a href="community.html" class="btn-secondary btn-sm" style="text-decoration:none;">üåê Community Routes</a>
      <span id="userDisplay" style="display:none; align-items:center; font-size:12px; color:var(--fg); font-family:var(--head); letter-spacing:.04em;"></span>
      <button id="btnLogin"  class="btn-secondary btn-sm">üîë Sign in with Google</button>
      <button id="btnLogout" class="btn-danger btn-sm" style="display:none;">Sign Out</button>
      <div class="vsep"></div>
      <button id="exportZipBtn" class="btn-secondary btn-sm">‚¨á Export ZIP</button>
      <button id="clearCacheBtn" class="btn-danger btn-sm">‚úï Clear All</button>
    </div>
  </header>

  <aside id="sidebar-left">
    <div class="panel-head">
      <span class="panel-title">Routes</span>
      <span class="route-legend">
        <span title="Saved locally (cache only)">üíæ cache</span>
        <span title="Saved to cloud">‚òÅ cloud</span>
      </span>
    </div>
    <div id="route-tree">
      <div class="sidebar-empty" id="route-empty">
        <div class="e-icon">üó∫</div>
        Import a route JSON to get started
      </div>
    </div>
  </aside>

  <main id="main">
    <div id="map-toolbar">
      <div class="file-btn-wrap">
        <button id="btnLoadMap" class="btn-secondary btn-sm">üìÇ Load Map</button>
        <input type="file" id="mapUpload" accept="image/*" />
      </div>
      <div class="vsep"></div>
      <label class="check-wrap"><input type="checkbox" id="reverse" /> Reverse</label>
      <label class="check-wrap"><input type="checkbox" id="boxes" /> Box Gates</label>
      <div class="vsep"></div>
      <label class="check-wrap">
        <span style="color:var(--muted);font-size:11px;font-family:var(--head);letter-spacing:.06em;text-transform:uppercase;">Scale</span>
        <select id="scale_mode">
          <option value="1">√ó1 (none)</option>
          <option value="2">√ó2</option>
        </select>
      </label>
      
      <div class="vsep"></div>
      
      <div class="topbar-align-group">
        <span class="toolbar-label">Auto-Align:</span>
        <input type="number" id="aaFrom" class="topbar-num-input" placeholder="From" title="Start Waypoint Index" />
        <input type="number" id="aaTo"   class="topbar-num-input" placeholder="To"   title="End Waypoint Index" />
        <button id="btnAutoAlign" class="btn-primary btn-sm" title="Align waypoints in range using angle bisectors">‚ü≥ Align</button>
      </div>

      <div id="routeStateBadges" style="display:flex;gap:4px;align-items:center;"></div>
      <input type="number" id="rotation_angle" value="0" style="display:none;" />
    </div>

    <div id="routeCanvas">
      <div class="map-hint">Scroll to Zoom ¬∑ Drag to Pan ¬∑ Click Waypoint to Select</div>
    </div>
  </main>

  <aside id="sidebar-right">
    <div class="tabs">
      <button class="tab on" data-pane="pane-process">Process</button>
      <button class="tab" data-pane="pane-json">JSON</button>
    </div>

    <div class="tab-pane on" id="pane-process">

      <div id="inspector">
        <div class="inspector-head">
          <span class="inspector-title">Inspector</span>
          <span class="inspector-wp-label" id="inspectorWpLabel"></span>
        </div>

        <div class="inspector-select-row">
          <label for="wpSelect">Waypoint</label>
          <select id="wpSelect">
            <option value="-1">‚Äî no route loaded ‚Äî</option>
          </select>
        </div>

        <div id="inspectorEmpty" class="inspector-empty">
          Click a waypoint on the map<br>or select from the dropdown above
        </div>

        <div id="inspectorBody" class="inspector-body" style="display:none;">
          <div class="insp-row">
            <label>Gate Width (Y)</label>
            <input type="number" id="inpWidth" value="10" step="0.5" />
          </div>
          <div class="insp-row">
            <label>Depth (X)</label>
            <input type="number" id="inpHeight" value="1" step="0.1" />
          </div>
          <div class="insp-row">
            <label>Height (Z)</label>
            <input type="number" id="inpDepth" value="1" step="0.1" />
          </div>
          <div class="insp-rot-val" id="rotateVal">0</div>
          <div class="insp-rot-label">rotation ¬∞</div>
          <input type="range" id="rotSlider" min="-180" max="180" value="0" />
          <button id="btnSaveWaypoint" class="btn-success btn-full insp-save-btn">üíæ Save Changes</button>
        </div>
      </div>

      <div class="process-body">
        <div id="routeVisibilityRow" style="display:none; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border);">
          <label class="check-wrap" style="margin:0;">
            <input type="checkbox" id="chkRoutePublic" checked />
            <span style="font-size:11px; color:var(--muted);">Public (visible in Community)</span>
          </label>
        </div>

        <div id="routeDescRow" style="display:flex;flex-direction:column;gap:4px;padding:8px 0;border-bottom:1px solid var(--border);">
          <label style="font-family:var(--head);font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);">Description <span style="color:var(--border2);font-weight:400;">(optional ¬∑ 280 chars)</span></label>
          <textarea id="routeDescription" maxlength="280" rows="2" placeholder="Short description shown in Community‚Ä¶" style="background:var(--panel);border:1px solid var(--border2);border-radius:3px;color:var(--text);font-size:12px;padding:6px 8px;font-family:var(--body);outline:none;resize:vertical;min-height:44px;transition:border-color .15s;"></textarea>
          <span id="descCharCount" style="font-family:var(--mono);font-size:9px;color:var(--border2);text-align:right;">0 / 280</span>
        </div>
        <div>
          <div class="sg-title" style="margin-bottom:8px;">Route Category</div>
          <div id="routeCatEditor" class="route-cat-row" style="background:var(--panel);border-radius:4px;border:1px solid var(--border2);">
            <button class="cat-toggle tag-sprint"    data-cat="Sprint">Sprint</button>
            <button class="cat-toggle tag-circuit"   data-cat="Circuit">Circuit</button>
            <button class="cat-toggle tag-endurance" data-cat="Endurance">Endurance</button>
            <button class="cat-toggle tag-offroad"   data-cat="Offroad">Offroad</button>
            <button class="cat-toggle tag-dakar"     data-cat="Dakar">Dakar</button>
            <button class="cat-toggle tag-hills"     data-cat="Hills">Hills</button>
            <button class="cat-toggle tag-technical" data-cat="Technical">Technical</button>
            <button class="cat-toggle tag-speed"     data-cat="Speed">Speed</button>
          </div>
        </div>

        <div>
          <div class="sg-title" style="margin-bottom:10px;">How to Use</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            </div>
        </div>
      </div>

      <div class="process-footer">
        <button id="importFromWebBtn" class="btn-import btn-full">‚¨á Import to Website</button>
        <button id="exportToWebBtn"   class="btn-success btn-full">‚¨Ü Export from Website</button>
        <button id="processBtn"       class="btn-primary btn-full">‚ñ∂ Process Event</button>
        <button id="saveCacheBtn"     class="btn-secondary btn-full">üíæ Save to Cache</button>
      </div>
    </div>

    <div class="tab-pane" id="pane-json">
      </div>

  </aside>
</div>

<div id="toast">Done!</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="math-utils.js"></script>
<script src="route-processor.js"></script>
<script src="map-visualizer.js"></script>
<script src="waypoint-ui.js"></script>
<script src="inspector.js"></script>
<script src="auto-align.js"></script>
<script src="main.js"></script>

</body>
</html>