<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MotorTown Route Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800&family=Barlow:wght@300;400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
</head>
<body>
<div id="app">

  <!-- ‚ïê‚ïê TOPBAR ‚ïê‚ïê -->
  <header id="topbar">
    <div class="logo">
      <div class="logo-mark"></div>
      <span class="logo-text">Motor<em>Town</em> Route Editor</span>
    </div>
    <div class="vsep"></div>
    <div class="status-pill">
      <div class="dot"></div>
      <span id="mapStatus">Trying auto-load‚Ä¶</span>
    </div>

    <!-- ‚îÄ‚îÄ Auth controls (right side of topbar) ‚îÄ‚îÄ -->
    <div class="topbar-end">
      <a href="community.html" class="btn-secondary btn-sm" style="text-decoration:none;">üåê Community Routes</a>
      <span id="userDisplay" style="display:none; align-items:center; font-size:12px; color:var(--fg); font-family:var(--head); letter-spacing:.04em;"></span>
      <button id="btnLogin"  class="btn-secondary btn-sm">üîë Sign in with Google</button>
      <button id="btnLogout" class="btn-danger btn-sm" style="display:none;">Sign Out</button>
      <div class="vsep"></div>
      <button id="exportZipBtn" class="btn-secondary btn-sm">‚¨á Export ZIP</button>
      <button id="clearCacheBtn" class="btn-danger btn-sm">‚úï Clear All</button>
    </div>
  </header>

  <!-- ‚ïê‚ïê LEFT SIDEBAR ‚Äî Route Tree ‚ïê‚ïê -->
  <aside id="sidebar-left">
    <div class="panel-head">
      <span class="panel-title">Routes</span>
    </div>
    <div id="route-tree">
      <div class="sidebar-empty" id="route-empty">
        <div class="e-icon">üó∫</div>
        Import a route JSON to get started
      </div>
    </div>
  </aside>

  <!-- ‚ïê‚ïê MAP ‚ïê‚ïê -->
  <main id="main">
    <div id="map-toolbar">
      <div class="file-btn-wrap">
        <button id="btnLoadMap" class="btn-secondary btn-sm">üìÇ Load Map</button>
        <input type="file" id="mapUpload" accept="image/*" />
      </div>
      <div class="vsep"></div>
      <label class="check-wrap"><input type="checkbox" id="reverse" /> Reverse</label>
      <label class="check-wrap"><input type="checkbox" id="boxes" /> Box Waypoints</label>
      <div class="vsep"></div>
      <label class="check-wrap">
        <span style="color:var(--muted);font-size:11px;font-family:var(--head);letter-spacing:.06em;text-transform:uppercase;">Scale</span>
        <select id="scale_mode">
          <option value="1">√ó1 (none)</option>
          <option value="2">√ó2</option>
        </select>
      </label>
      <input type="number" id="rotation_angle" value="0" style="display:none;" />
    </div>

    <div id="routeCanvas">
      <div class="map-hint">Scroll to Zoom ¬∑ Drag to Pan ¬∑ Click Waypoint to Select</div>
    </div>
  </main>

  <!-- ‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê -->
  <aside id="sidebar-right">
    <div class="tabs">
      <button class="tab on" data-pane="pane-process">Process</button>
      <button class="tab" data-pane="pane-json">JSON</button>
    </div>

    <!-- ‚îÄ‚îÄ PROCESS TAB ‚îÄ‚îÄ -->
    <div class="tab-pane on" id="pane-process">

      <!-- INSPECTOR -->
      <div id="inspector">
        <div class="inspector-head">
          <span class="inspector-title">Inspector</span>
          <span class="inspector-wp-label" id="inspectorWpLabel"></span>
        </div>

        <div class="inspector-select-row">
          <label for="wpSelect">Waypoint</label>
          <select id="wpSelect">
            <option value="-1">‚Äî no route loaded ‚Äî</option>
          </select>
        </div>

        <div id="inspectorEmpty" class="inspector-empty">
          Click a waypoint on the map<br>or select from the dropdown above
        </div>

        <div id="inspectorBody" class="inspector-body" style="display:none;">
          <div class="insp-row">
            <label>Gate Width (Y)</label>
            <input type="number" id="inpWidth" value="10" step="0.5" />
          </div>
          <div class="insp-row">
            <label>Depth (X)</label>
            <input type="number" id="inpHeight" value="1" step="0.1" />
          </div>
          <div class="insp-row">
            <label>Height (Z)</label>
            <input type="number" id="inpDepth" value="1" step="0.1" />
          </div>
          <div class="insp-rot-val" id="rotateVal">0</div>
          <div class="insp-rot-label">rotation ¬∞</div>
          <input type="range" id="rotSlider" min="-180" max="180" value="0" />
          <button id="btnSaveWaypoint" class="btn-success btn-full insp-save-btn">üíæ Save Changes</button>
        </div>
      </div>

      <!-- SCROLLABLE CONTENT -->
      <div class="process-body">
        <!-- Visibility toggle (shown only when logged in) -->
        <div id="routeVisibilityRow" style="display:none; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border);">
          <label class="check-wrap" style="margin:0;">
            <input type="checkbox" id="chkRoutePublic" checked />
            <span style="font-size:11px; color:var(--muted);">Public (visible in Community)</span>
          </label>
        </div>

        <div>
          <div class="sg-title" style="margin-bottom:8px;">How to use</div>
          <p class="step-hint">
            1. <strong>Sign in</strong> with Google (top-right) to save routes to the cloud and share with the community.<br><br>
            2. Click <strong>Import to Website</strong> to paste your copied route JSON.<br><br>
            3. Set <strong>Scale</strong>, <strong>Box Waypoints</strong>, or <strong>Reverse</strong> in the toolbar.<br><br>
            4. Hit <em>Process Event</em> ‚Äî result appears on the map and in the JSON tab.<br><br>
            5. Click a waypoint on the map (or use the Inspector dropdown) to edit its properties.<br><br>
            6. Click <strong>Save Changes</strong> ‚Äî routes sync to the cloud automatically when signed in.<br><br>
            7. Visit <a href="community.html" style="color:var(--accent);">Community Routes</a> to browse and load other players' routes.
          </p>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="process-footer">
        <button id="importFromWebBtn" class="btn-import btn-full">‚¨á Import to Website</button>
        <button id="exportToWebBtn"   class="btn-success btn-full">‚¨Ü Export from Website</button>
        <button id="processBtn"       class="btn-primary btn-full">‚ñ∂ Process Event</button>
        <button id="saveCacheBtn"     class="btn-secondary btn-full">üíæ Save to Cache</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ JSON TAB ‚îÄ‚îÄ -->
    <div class="tab-pane" id="pane-json">
      <div class="json-tab-wrap">
        <div class="json-box">
          <div class="box-header">
            <span class="box-header-label">Input</span>
            <button class="btn-ghost btn-sm" onclick="document.getElementById('json_data').value=''">Clear</button>
          </div>
          <textarea id="json_data" placeholder="Paste your route JSON here‚Ä¶"></textarea>
        </div>
        <div class="json-divider"></div>
        <div class="json-box">
          <div class="box-header">
            <span class="box-header-label">Output</span>
            <button class="btn-ghost btn-sm" id="copyOutputBtn">Copy</button>
          </div>
          <textarea id="output" placeholder="Processed output will appear here‚Ä¶" style="color:#ce9178;"></textarea>
        </div>
      </div>
    </div>

  </aside>
</div>

<div id="toast">Done!</div>

<!-- ‚ïê‚ïê PROFILE SETUP MODAL ‚ïê‚ïê -->
<div id="profileModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; align-items:center; justify-content:center;">
  <div class="modal-box">
    <h2 class="modal-title">Complete Your Profile</h2>
    <p class="modal-subtitle">Set your in-game and Discord names. These are shown publicly on Community Routes.</p>
    <div class="modal-field">
      <label for="inpIngameName">In-Game Name</label>
      <input id="inpIngameName" type="text" maxlength="64" placeholder="Your character name in MotorTown" autocomplete="off" />
    </div>
    <div class="modal-field">
      <label for="inpDiscordName">Discord Username</label>
      <input id="inpDiscordName" type="text" maxlength="64" placeholder="e.g. username#1234 or username" autocomplete="off" />
    </div>
    <p id="profileError" style="color:#ff5555; font-size:12px; min-height:16px; margin:4px 0;"></p>
    <button id="btnSaveProfile" class="btn-primary btn-full">Save Profile</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="math-utils.js"></script>
<script src="route-processor.js"></script>
<script src="map-visualizer.js"></script>
<script src="inspector.js"></script>
<script src="main.js"></script>

<!-- Firebase modules loaded as ES modules -->
<script type="module" src="firebase-config.js"></script>
<script type="module" src="auth-ui.js"></script>
<script type="module" src="firestore-routes.js"></script>
<script type="module">
  // Initialize auth UI after modules load
  document.addEventListener('DOMContentLoaded', () => {
    window.AuthUI?.init();
  });
  // If DOM already loaded (modules can be deferred):
  if (document.readyState !== 'loading') {
    window.AuthUI?.init();
  }
</script>

<!-- main-overrides must load AFTER the non-module scripts AND after Firebase modules are initialized -->
<!-- We defer it slightly so Firebase modules are ready -->
<script>
  window.addEventListener('load', () => {
    const s = document.createElement('script');
    s.src = 'main-overrides.js';
    document.body.appendChild(s);
  });
</script>

</body>
</html>
